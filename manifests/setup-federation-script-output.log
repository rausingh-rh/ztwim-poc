rausingh@rausingh-thinkpadp16vgen1:~/Documents/oape/ztwim-poc/federation-setup$ ./setup-federation.sh /home/rausingh/Downloads/kubeconfig /home/rausingh/Downloads/kubeconfigani

╔════════════════════════════════════════════════════════════════════╗
║         SPIRE Federation Setup Script                             ║
╚════════════════════════════════════════════════════════════════════╝

Cluster 1 kubeconfig: /home/rausingh/Downloads/kubeconfig
Cluster 2 kubeconfig: /home/rausingh/Downloads/kubeconfigani
Working directory: /tmp/spire-federation-setup-599217

Step 1: Gathering cluster information...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Cluster 1: Trust Domain = apps.mykastur14.gcp.devcluster.openshift.com
✓ Cluster 2: Trust Domain = apps.aagnihot-cluster-kdh.devcluster.openshift.com

Step 2: Configuring federation endpoints...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Creating federation services and routes...
service/spire-server-federation created
route.route.openshift.io/spire-server-federation created
service/spire-server-federation created
route.route.openshift.io/spire-server-federation created
✓ Cluster 1 federation endpoint: https://spire-server-federation-zero-trust-workload-identity-manager.apps.mykastur14.gcp.devcluster.openshift.com
✓ Cluster 2 federation endpoint: https://spire-server-federation-zero-trust-workload-identity-manager.apps.aagnihot-cluster-kdh.devcluster.openshift.com

Updating SPIRE server configurations...
Warning: resource configmaps/spire-server is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
configmap/spire-server configured
Warning: resource configmaps/spire-server is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
configmap/spire-server configured
✓ Updated SPIRE server configurations

Step 3: Exposing federation port on SPIRE servers...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
statefulset.apps/spire-server patched
statefulset.apps/spire-server patched
✓ Federation port exposed

Step 4: Restarting SPIRE servers...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
statefulset.apps/spire-server restarted
statefulset.apps/spire-server restarted
Waiting for SPIRE servers to be ready...
pod/spire-server-0 condition met
pod/spire-server-0 condition met
✓ SPIRE servers restarted and ready

Step 5: Extracting trust bundles...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Trust bundles extracted

Step 6: Creating ClusterFederatedTrustDomain resources...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
clusterfederatedtrustdomain.spire.spiffe.io/cluster-2-federation configured
clusterfederatedtrustdomain.spire.spiffe.io/cluster-1-federation created
✓ ClusterFederatedTrustDomain resources created

Step 7: Deploying test workloads with federation...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
namespace/federation-demo created
serviceaccount/test-workload-c1 created
clusterspiffeid.spire.spiffe.io/test-workload-c1 created
deployment.apps/test-workload-c1 created
✓ Deployed test workload to Cluster 1
namespace/federation-demo created
serviceaccount/test-workload-c2 created
clusterspiffeid.spire.spiffe.io/test-workload-c2 created
deployment.apps/test-workload-c2 created
✓ Deployed test workload to Cluster 2

Waiting for workload pods to be ready...
pod/test-workload-c1-776cc68498-kf66g condition met
pod/test-workload-c2-78ffff98f7-k6g49 condition met
✓ Workloads deployed and ready

Waiting for SPIRE entries to be created...

Step 8: Verifying federation in workload entries...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🧪 Testing Federation...

1. Trust bundles on Cluster 1:
───────────────────────────────
****************************************
* apps.aagnihot-cluster-fdi.devcluster.openshift.com
****************************************
-----BEGIN CERTIFICATE-----
MIIEKzCCAxOgAwIBAgIRAPxae+S/NWO7m6IDCeeKFnIwDQYJKoZIhvcNAQELBQAw
gYkxCzAJBgNVBAYTAlVTMQswCQYDVQQKEwJSSDE7MDkGA1UEAxMyYXBwcy5hYWdu
aWhvdC1jbHVzdGVyLWZkaS5kZXZjbHVzdGVyLm9wZW5zaGlmdC5jb20xMDAuBgNV
BAUTJzMzNTQzNTI3NDUxNDY0NTQxNzc4NTQxMjE5OTQxNDY0MDU0NzQ0MjAeFw0y
NTEwMTYwNjU0NDhaFw0yNTEwMTcwNjU0NThaMIGJMQswCQYDVQQGEwJVUzELMAkG
A1UEChMCUkgxOzA5BgNVBAMTMmFwcHMuYWFnbmlob3QtY2x1c3Rlci1mZGkuZGV2
Y2x1c3Rlci5vcGVuc2hpZnQuY29tMTAwLgYDVQQFEyczMzU0MzUyNzQ1MTQ2NDU0
MTc3ODU0MTIxOTk0MTQ2NDA1NDc0NDIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAw
ggEKAoIBAQCWsKhIGzSC5EeXVH6ZMBwIc5Hdxjks56KggR/K/doc2pYOjK+AC0XW
iAedQ3zav9zrADdgtXHx8sFoD+OY8VhRbjXkJXxUyg4IThcxDGNA5vhWFAtYFGGb
SGBm80K34heV8BWzk2Vp4YL+qzizIeIgcVDFCG8d9wQZp6r8G+FAYLOP+PHHog7A
6FMlYFM4j1wEp7PFXySUSoZtafQBQUHbo04Mc3KSSyrGEzPXsf7OuSipg2ViJBZP
orOxdBPpbgLrTXZygxbvuUyVVL2nVNLR/CqQbpaC3bq2T1eLTkdWv9vuvKjUdubL
tCQ4ht7s4ZCPXnykGGC69Yid75iUA55JAgMBAAGjgYswgYgwDgYDVR0PAQH/BAQD
AgEGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFHZR7AY+/ATVLElqHq+7630q
LDh6MEYGA1UdEQQ/MD2GO3NwaWZmZTovL2FwcHMuYWFnbmlob3QtY2x1c3Rlci1m
ZGkuZGV2Y2x1c3Rlci5vcGVuc2hpZnQuY29tMA0GCSqGSIb3DQEBCwUAA4IBAQAG
TchAAth8ZEezfV93IkMtPUnm29uUjq6dVV3QqGfCCqNeJTwWNOQG57UKtrlSbD3Q
M53uQC//Z9RzeqSQag7Gcf5SKjRxL3etkVXhUJfvcaT5PLv136+EzwH3mOhB/fpQ
K9rl08Dc1cL1ENIeagopgRetGKnGg0yLySyGMAxwPbxOqjfjl43vX0rjEfsMIA/n
z4+5frgvLEiPU6yCbAA4pffQ/FFQE2JE/VmfpHsv5+3xtWg9C6JufFn9HXrHvyaB
MvlCvzx1KcRsHCcwBd7gyR7qaUHicNjyJOcjKIUaiicYmgzjmF8Y8xXOg0RweFQK
5h37kGNcGIP/gB+K47FN
-----END CERTIFICATE-----

****************************************
* apps.aagnihot-cluster-kdh.devcluster.openshift.com
****************************************
-----BEGIN CERTIFICATE-----
MIIEKjCCAxKgAwIBAgIQd3/hafNtdhmOfWp/UTrlczANBgkqhkiG9w0BAQsFADCB
iTELMAkGA1UEBhMCVVMxCzAJBgNVBAoTAlJIMTswOQYDVQQDEzJhcHBzLmFhZ25p
aG90LWNsdXN0ZXIta2RoLmRldmNsdXN0ZXIub3BlbnNoaWZ0LmNvbTEwMC4GA1UE
BRMnMTU4ODQyMTI1MTM1ODkzOTg1NjE5NTgzMTU1MjIyMzk1Njc2MDE5MB4XDTI1
MTAxNzEyNDYwMVoXDTI1MTAxODEyNDYxMVowgYkxCzAJBgNVBAYTAlVTMQswCQYD
VQQKEwJSSDE7MDkGA1UEAxMyYXBwcy5hYWduaWhvdC1jbHVzdGVyLWtkaC5kZXZj
bHVzdGVyLm9wZW5zaGlmdC5jb20xMDAuBgNVBAUTJzE1ODg0MjEyNTEzNTg5Mzk4
NTYxOTU4MzE1NTIyMjM5NTY3NjAxOTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCC
AQoCggEBANOJ9e1LsmUJX9TxYJBOXWl5aPNDVc8tpILFZQpn8fqI69ousVNEgQxh
a4toL3u9U3iWhGFlQDK2UYQKNB7eobWOD6F8cun71D8GBT4W4PCLmc25/xa9QQEp
keZqepl3DLRqHVvV49Ryq/KXknF+a2IDC/Xv+b293QQL2pUBzZOTBsbng6k7tofl
HbVrW8KRx6r4d6zCPRRIQaK72ImXjgwVkCm8gKYZAyZIgF35vt9Ewe1OzkEUiGKn
ByKyFUq3v/VeFZ1udZnpY3bw6NHxW4LaL6JCJJMMl3hgJN24PKy06QAN+oNHSWmS
a1EWl3dKiNW9PyM8shkBn9bskoW79nUCAwEAAaOBizCBiDAOBgNVHQ8BAf8EBAMC
AQYwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQUNvVjYn+lya+FbOI0hN4LxKfV
0r0wRgYDVR0RBD8wPYY7c3BpZmZlOi8vYXBwcy5hYWduaWhvdC1jbHVzdGVyLWtk
aC5kZXZjbHVzdGVyLm9wZW5zaGlmdC5jb20wDQYJKoZIhvcNAQELBQADggEBABmi
WOfT2kwQEE6nIVQoA6KJigctEqykHDOU3Uxof8Arb/762J31ImCLrZ/TcskhhcKe
kYP2ksW7xbVnk0atTf+nmVkgdUP41FpYYxOXi0VViahxxCjfx8DzdDWGrk7Y7hAM
jADzOo7QGWtF7H9mbsP9Z+B67zzTozICLWiBbwwgZBeX0WuTDkwTcZpdaYaXVL+9
ZxUWCYn74/QbHTIO7E1Uz8ZlWUlmd2+RDmg0d4svFEgU67e/NLEJvEDBNf6xr/C9
jIVuYclTDln9KPy1h2b76vUUY72NKuRFcMcluH54OHTJMks1GBrU6JZ0lkF7Ex47
C40zMHFoNVbjGvYgPR4=
-----END CERTIFICATE-----

2. Trust bundles on Cluster 2:
───────────────────────────────
****************************************
* apps.mykastur14.gcp.devcluster.openshift.com
****************************************
-----BEGIN CERTIFICATE-----
MIIEFjCCAv6gAwIBAgIQPKWwf3zNzw+zYPdhZQ+STjANBgkqhkiG9w0BAQsFADCB
gjELMAkGA1UEBhMCVVMxCzAJBgNVBAoTAlJIMTUwMwYDVQQDEyxhcHBzLm15a2Fz
dHVyMTQuZ2NwLmRldmNsdXN0ZXIub3BlbnNoaWZ0LmNvbTEvMC0GA1UEBRMmODA2
MTM5ODg1MzM0NDUwMjk3Njg4NTc5NTAxNjA1NzI4Nzk0MzgwHhcNMjUxMDE3MTI0
MTAzWhcNMjUxMDE4MTI0MTEzWjCBgjELMAkGA1UEBhMCVVMxCzAJBgNVBAoTAlJI
MTUwMwYDVQQDEyxhcHBzLm15a2FzdHVyMTQuZ2NwLmRldmNsdXN0ZXIub3BlbnNo
aWZ0LmNvbTEvMC0GA1UEBRMmODA2MTM5ODg1MzM0NDUwMjk3Njg4NTc5NTAxNjA1
NzI4Nzk0MzgwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC08tYf2P67
5RZI7awc1GSDrYx+FPZYDsXzooiRW5SalqUHPWtsAMyZT3Qfqa9dZT3UzLv9EkE+
3vDgUZlbUf2w1UlpkiIIM/choFn2J/U7g2Z6GcLtf3UE2jMXZZZguWCBTfCcLWPY
Pcz/iMr2ruP4I2kpgEKjQ93Xh8Dt+pEE/SiOAiyuKWvjFF1SUMiYSjRKe6PEIOlN
PltAYFDoYKnSaI9AStW2iRY4MuZwip44M3iY2iSmIgajjikutg2J8TQl8d5FevtW
c7+LL5bTL6pS57DEGCW+Q+yeDYlUxsS77NWQRyaf2JTrgCztcHUzNegL/jU/kzdQ
Pn2diyK2TvuzAgMBAAGjgYUwgYIwDgYDVR0PAQH/BAQDAgEGMA8GA1UdEwEB/wQF
MAMBAf8wHQYDVR0OBBYEFJphtROS6pxFPPP/+IgPWarBiolbMEAGA1UdEQQ5MDeG
NXNwaWZmZTovL2FwcHMubXlrYXN0dXIxNC5nY3AuZGV2Y2x1c3Rlci5vcGVuc2hp
ZnQuY29tMA0GCSqGSIb3DQEBCwUAA4IBAQAOpU/FfLr69elJzqlr18l6lkLi3y1Z
TibTzUQbBXyIlonpZFqlggRKVEjL+uuBRYn1F6FYaaUp0p7TyrBFmEBkRhdl43WX
mNpoUckGf5lxeg5p7HTsNJ9ZImqj8fH9qmEPxfpMQqxHxlNaZPT95o2WBVuLGdr+
dTpTFAFk2+ZHsTYYABsTOZ4YXsVJowSreGlM5aYomgsmJPLMLC8J3qdDpY2iyQ4e
4hUOq9y29S9MohGmL+rhMwhsGiIrZ/7smhA1pNljDSfyojMpZHJUfV2jGgonEzpc
tc20WngVmY07FwcqyThI64QHDH+QqKqhsOC5aVm8gAYip4Uv+6npJZAO
-----END CERTIFICATE-----

3. Workload entries on Cluster 1 (showing 'federates with'):
──────────────────────────────────────────────────────────────
SPIFFE ID        : spiffe://apps.mykastur14.gcp.devcluster.openshift.com/ns/federation-demo/sa/test-workload-c1
Parent ID        : spiffe://apps.mykastur14.gcp.devcluster.openshift.com/spire/agent/k8s_psat/rausingh-1/13ac6c69-94ba-4bae-a2fd-a21388127ee0
Revision         : 0
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:pod-uid:9eac6c04-c98e-40fd-8a97-71b4ce165a5b
FederatesWith    : apps.aagnihot-cluster-kdh.devcluster.openshift.com

Entry ID         : rausingh-1.889ff442-b486-4c57-8267-b5c4f7c1e16c
SPIFFE ID        : spiffe://apps.mykastur14.gcp.devcluster.openshift.com/ns/zero-trust-workload-identity-manager/sa/spire-spiffe-oidc-discovery-provider
Parent ID        : spiffe://apps.mykastur14.gcp.devcluster.openshift.com/spire/agent/k8s_psat/rausingh-1/908a17fa-bc0b-4c21-9a03-7af747120bce
Revision         : 0
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:pod-uid:9968a003-ac85-43b1-afbf-9eac7ceba510
DNS name         : oidc-discovery.apps.mykastur14.gcp.devcluster.openshift.com
DNS name         : spire-spiffe-oidc-discovery-provider
DNS name         : spire-spiffe-oidc-discovery-provider.zero-trust-workload-identity-manager
DNS name         : spire-spiffe-oidc-discovery-provider.zero-trust-workload-identity-manager.svc
DNS name         : spire-spiffe-oidc-discovery-provider.zero-trust-workload-identity-manager.svc.cluster.local
Hint             : oidc-discovery-provider


4. Workload entries on Cluster 2 (showing 'federates with'):
──────────────────────────────────────────────────────────────
SPIFFE ID        : spiffe://apps.aagnihot-cluster-kdh.devcluster.openshift.com/ns/federation-demo/sa/test-workload-c2
Parent ID        : spiffe://apps.aagnihot-cluster-kdh.devcluster.openshift.com/spire/agent/k8s_psat/anirudh-1/ffe48454-ff55-4523-ae93-e484a7ecac89
Revision         : 0
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:pod-uid:e3118675-dc31-4a71-97f7-e2ae960e7942
FederatesWith    : apps.mykastur14.gcp.devcluster.openshift.com

Entry ID         : anirudh-1.5d3217d3-cca9-4e6d-8c78-5691fdf7644d
SPIFFE ID        : spiffe://apps.aagnihot-cluster-kdh.devcluster.openshift.com/ns/zero-trust-workload-identity-manager/sa/spire-spiffe-oidc-discovery-provider
Parent ID        : spiffe://apps.aagnihot-cluster-kdh.devcluster.openshift.com/spire/agent/k8s_psat/anirudh-1/ad1cc5d5-ab72-4de3-86c1-065377cfc77e
Revision         : 0
X509-SVID TTL    : default
JWT-SVID TTL     : default
Selector         : k8s:pod-uid:55cbc9e6-c757-450b-a50a-e93c228b145f
DNS name         : oidc-discovery.apps.aagnihot-cluster-kdh.devcluster.openshift.com
DNS name         : spire-spiffe-oidc-discovery-provider
DNS name         : spire-spiffe-oidc-discovery-provider.zero-trust-workload-identity-manager
DNS name         : spire-spiffe-oidc-discovery-provider.zero-trust-workload-identity-manager.svc
DNS name         : spire-spiffe-oidc-discovery-provider.zero-trust-workload-identity-manager.svc.cluster.local
Hint             : oidc-discovery-provider


5. Recent bundle rotations on Cluster 1:
─────────────────────────────────────────
time="2025-10-17T13:08:51Z" level=info msg="Bundle refreshed" subsystem_name=bundle_client trust_domain=apps.aagnihot-cluster-kdh.devcluster.openshift.com
time="2025-10-17T13:10:06Z" level=info msg="Bundle refreshed" subsystem_name=bundle_client trust_domain=apps.aagnihot-cluster-kdh.devcluster.openshift.com
time="2025-10-17T13:11:21Z" level=info msg="Bundle refreshed" subsystem_name=bundle_client trust_domain=apps.aagnihot-cluster-kdh.devcluster.openshift.com
time="2025-10-17T13:12:36Z" level=info msg="Bundle refreshed" subsystem_name=bundle_client trust_domain=apps.aagnihot-cluster-kdh.devcluster.openshift.com
time="2025-10-17T13:13:52Z" level=info msg="Bundle refreshed" subsystem_name=bundle_client trust_domain=apps.aagnihot-cluster-kdh.devcluster.openshift.com

╔════════════════════════════════════════════════════════════════════╗
║                    FEDERATION SETUP COMPLETE!                      ║
╚════════════════════════════════════════════════════════════════════╝

✓ Federation configured between:
  • Cluster 1: apps.mykastur14.gcp.devcluster.openshift.com
  • Cluster 2: apps.aagnihot-cluster-kdh.devcluster.openshift.com

✓ Test workloads deployed:
  • Cluster 1: test-workload-c1 (federates with apps.aagnihot-cluster-kdh.devcluster.openshift.com)
  • Cluster 2: test-workload-c2 (federates with apps.mykastur14.gcp.devcluster.openshift.com)

📋 What was demonstrated:
  1. Trust bundle exchange between clusters
  2. ClusterFederatedTrustDomain resources created
  3. Workload entries showing 'federates with' field
  4. Both clusters can verify each other's identities

📋 Next Steps:
  • Deploy mTLS-enabled applications that communicate across clusters
  • Verify SVIDs include federated trust bundles
  • Monitor bundle rotation logs

🔍 Useful Commands:

View all workload entries on Cluster 1:
  kubectl --kubeconfig /home/rausingh/Downloads/kubeconfig exec -n zero-trust-workload-identity-manager spire-server-0 -c spire-server -- ./spire-server entry show

View all workload entries on Cluster 2:
  kubectl --kubeconfig /home/rausingh/Downloads/kubeconfigani exec -n zero-trust-workload-identity-manager spire-server-0 -c spire-server -- ./spire-server entry show

Check ClusterFederatedTrustDomain status on Cluster 1:
  kubectl --kubeconfig /home/rausingh/Downloads/kubeconfig get clusterfederatedtrustdomain -o yaml

Check ClusterFederatedTrustDomain status on Cluster 2:
  kubectl --kubeconfig /home/rausingh/Downloads/kubeconfigani get clusterfederatedtrustdomain -o yaml

View workload pods:
  kubectl --kubeconfig /home/rausingh/Downloads/kubeconfig get pods -n federation-demo
  kubectl --kubeconfig /home/rausingh/Downloads/kubeconfigani get pods -n federation-demo

Setup complete! Your SPIRE federation is operational.



